input {
  http {

     host => "https://explorer.dea.ga.gov.au/stac/collections/ga_s2bm_ard_3/items/b562811f-c4bc-405a-aca8-15038c6521ad"
     port => 8080

  }

}

filter {
  # Parse and transform GeoJSON features for OpenSearch
  if [features] {
    # Split the features array into individual documents
    split {
      field => "features"
    }
    
    # Extract geometry and properties from each feature
    ruby {
      code => "
        feature = event.get('features')
        if feature && feature.is_a?(Hash)
          # Extract geometry
          if feature['geometry']
            geometry = feature['geometry']
            event.set('geometry', geometry)
            
            # Create location field for OpenSearch geo_point mapping
            if geometry['type'] == 'Point' && geometry['coordinates']
              coords = geometry['coordinates']
              if coords.length >= 2
                # GeoJSON is [longitude, latitude], OpenSearch expects [lat, lon] or 'lat,lon'
                event.set('location', {
                  'lat' => coords[1],
                  'lon' => coords[0]
                })
              end
            end
          end
          
          # Extract properties
          if feature['properties']
            feature['properties'].each do |key, value|
              event.set(key, value)
            end
          end
          
          # Set feature type and id
          event.set('feature_type', feature['type']) if feature['type']
          event.set('feature_id', feature['id']) if feature['id']
        end
        
        # Remove the original features field to avoid duplication
        event.remove('features')
      "
    }
  }
  
  # Handle individual GeoJSON feature (if input is a single feature, not a collection)
  if [type] == "Feature" and [geometry] {
    ruby {
      code => "
        geometry = event.get('geometry')
        
        # Create location field for OpenSearch geo_point mapping
        if geometry && geometry['type'] == 'Point' && geometry['coordinates']
          coords = geometry['coordinates']
          if coords.length >= 2
            event.set('location', {
              'lat' => coords[1],
              'lon' => coords[0]
            })
          end
        end
        
        # Flatten properties to top level
        properties = event.get('properties')
        if properties && properties.is_a?(Hash)
          properties.each do |key, value|
            event.set(key, value)
          end
          event.remove('properties')
        end
        
        # Set metadata fields
        event.set('feature_type', event.get('type'))
        event.set('feature_id', event.get('id')) if event.get('id')
      "
    }
  }
  
  # Add timestamp
  date {
    match => [ "@timestamp", "ISO8601" ]
  }
  
  # Clean up metadata fields that aren't needed in OpenSearch
  mutate {
    remove_field => [ "http_poller_metadata", "@version" ]
  }
}

output {
  opensearch {
    hosts => ["https://opensearch-node:9200"]
    user => "admin"
    password => "becR11!@12"
    index => "geojson-%{+YYYY.MM.dd}"
    ssl_certificate_verification => false
    ecs_compatibility => disabled
    # Template for geo mapping
    template_name => "geojson"
    template => '{
      "index_patterns": ["geojson-*"],
      "mappings": {
        "properties": {
          "location": {
            "type": "geo_point"
          },
          "geometry": {
            "type": "geo_shape"
          },
          "@timestamp": {
            "type": "date"
          }
        }
      }
    }'
  }
}